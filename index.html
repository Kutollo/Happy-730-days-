<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smile Detect Anniversary Surprise</title>
  <style>
    :root{--pink:#ffd3e0;--panel:#fff0f3;--accent:#ff5777}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;color:#222}
    body{background:linear-gradient(180deg,var(--pink),#ffe6ef);display:flex;align-items:center;justify-content:center;padding:18px}
    .card{width:100%;max-width:980px;background:var(--panel);border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,0.12);overflow:hidden}
    header{padding:12px 16px;display:flex;align-items:center}
    header h1{font-size:18px;margin:0}
    .controls{margin-left:auto;display:flex;gap:10px;align-items:center}
    button{background:white;border:1px solid rgba(0,0,0,0.06);padding:8px 10px;border-radius:8px;cursor:pointer}
    button.important{background:var(--accent);color:white;border:none}.main{display:flex;gap:14px;padding:16px}
.left{flex:1;display:flex;flex-direction:column;gap:12px}
.video-wrap{position:relative;border-radius:12px;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center;height:420px}
video#webcam{width:100%;height:100%;object-fit:cover}

/* overlay message */
.message{position:absolute;left:50%;transform:translateX(-50%);top:14px;padding:10px 14px;border-radius:999px;background:rgba(255,255,255,0.92);font-weight:700;color:#8b1532;box-shadow:0 6px 18px rgba(0,0,0,0.12);display:flex;align-items:center;gap:10px}
.message.hidden{display:none}

/* slideshow area sits above video but hidden until triggered */
.slideshow{position:absolute;inset:0;display:none;align-items:center;justify-content:center}
.slideshow.show{display:flex}
.slide{position:absolute;max-width:90%;max-height:90%;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.35);object-fit:cover}

.right{width:300px}
.panel{background:white;border-radius:10px;padding:12px}
.panel h3{margin:0 0 8px 0}
input[type=file]{display:block}
label.small{font-size:13px}

footer{padding:10px 16px;font-size:13px;color:#6b3a45}

@media (max-width:820px){.main{flex-direction:column}.right{width:100%}.video-wrap{height:320px}}

  </style>
</head>
<body>
  <div class="card">
    <header>
      <h1>Smile Detect Anniversary Surprise</h1>
      <div class="controls">
        <button id="startBtn">Start Camera</button>
        <button id="stopBtn">Stop Camera</button>
        <button id="testSmile">Test Smile</button>
      </div>
    </header><div class="main">
  <div class="left">
    <div class="video-wrap">
      <video id="webcam" autoplay muted playsinline></video>

      <div class="message hidden" id="messageBox">Happy 2 Years Anniversary My Pink Heart ❤️</div>

      <div class="slideshow" id="slideshow">
        <!-- slides inserted here -->
      </div>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <button id="pauseSlides">Pause</button>
      <button id="resumeSlides">Resume</button>
      <button id="clearSlides">Clear Photos</button>
    </div>
  </div>

  <div class="right">
    <div class="panel">
      <h3>Upload photos for slideshow</h3>
      <p class="small">Select multiple pictures of you and your girlfriend. They will play when a smile is detected.</p>
      <input id="picsInput" type="file" accept="image/*" multiple>
      <div id="thumbs" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px"></div>

      <hr style="margin:12px 0">
      <h3>Settings</h3>
      <label class="small">Smile threshold: <span id="thVal">0.75</span></label>
      <input id="threshold" type="range" min="0.4" max="0.98" step="0.01" value="0.75">

      <label class="small">Slideshow interval (ms)</label>
      <input id="interval" type="number" value="2500" style="width:100%">
    </div>
  </div>
</div>

<footer>Tip: Allow camera access. When you smile the message appears and the slideshow will play.</footer>

  </div>  <!-- face-api.js from CDN. Models are loaded from a public model repo. -->  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>  <script>
    // Elements
    const webcam = document.getElementById('webcam');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const testSmile = document.getElementById('testSmile');
    const messageBox = document.getElementById('messageBox');
    const picsInput = document.getElementById('picsInput');
    const thumbs = document.getElementById('thumbs');
    const slideshow = document.getElementById('slideshow');
    const threshold = document.getElementById('threshold');
    const thVal = document.getElementById('thVal');
    const intervalInput = document.getElementById('interval');
    const pauseSlides = document.getElementById('pauseSlides');
    const resumeSlides = document.getElementById('resumeSlides');
    const clearSlides = document.getElementById('clearSlides');

    // models url - using public hosted models
    const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models/'

    let stream = null;
    let detectInterval = null;
    let slideInterval = null;
    let slides = [];
    let currentSlide = 0;
    let slidesPlaying = false;
    let lastSmileTime = 0;
    const SMILE_COOLDOWN = 5000; // ms between triggers

    thVal.innerText = threshold.value;
    threshold.addEventListener('input', ()=> thVal.innerText = threshold.value);

    // load face-api models
    async function loadModels(){
      // load tiny face detector and expression model
      await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
      await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
    }

    // start camera
    async function startCamera(){
      if (stream) return;
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
        webcam.srcObject = stream;
        await webcam.play();
        // begin detection loop
        startDetectionLoop();
      } catch(err){
        alert('Could not access camera: ' + err.message);
      }
    }

    function stopCamera(){
      if (stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
      }
      webcam.pause(); webcam.srcObject = null;
      stopDetectionLoop();
    }

    // detection
    function startDetectionLoop(){
      if (detectInterval) return;
      detectInterval = setInterval(async ()=>{
        if (webcam.readyState < 2) return;
        const options = new faceapi.TinyFaceDetectorOptions({inputSize:160, scoreThreshold:0.5});
        const res = await faceapi.detectSingleFace(webcam, options).withFaceExpressions();
        if (!res) return;
        const happy = res.expressions.happy || 0;
        // trigger if above threshold and cooldown elapsed
        const th = parseFloat(threshold.value);
        const now = Date.now();
        if (happy >= th && now - lastSmileTime > SMILE_COOLDOWN){
          lastSmileTime = now;
          triggerSmile();
        }
      }, 300);
    }
    function stopDetectionLoop(){ if (detectInterval){ clearInterval(detectInterval); detectInterval = null } }

    // when smile detected
    function triggerSmile(){
      showMessage();
      playChime();
      if (slides.length) startSlideshow();
    }

    // message animation
    let msgTimeout = null;
    function showMessage(){
      messageBox.classList.remove('hidden');
      // auto hide after 6s
      if (msgTimeout) clearTimeout(msgTimeout);
      msgTimeout = setTimeout(()=> messageBox.classList.add('hidden'), 6000);
    }

    // simple chime using WebAudio
    function playChime(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 880;
        g.gain.value = 0.0001;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        // ramp up then down
        g.gain.exponentialRampToValueAtTime(0.03, ctx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.5);
        o.stop(ctx.currentTime + 0.55);
      } catch(e){ console.warn('Audio play failed', e) }
    }

    // slideshow management
    function buildSlides(){
      slideshow.innerHTML = '';
      slides.forEach((src,i)=>{
        const img = document.createElement('img');
        img.src = src; img.className = 'slide';
        img.style.opacity = i===0 ? '1' : '0';
        slideshow.appendChild(img);
      });
    }

    function startSlideshow(){
      if (slidesPlaying) return;
      if (!slides.length) return;
      slideshow.classList.add('show');
      slidesPlaying = true;
      currentSlide = 0;
      const imgs = slideshow.querySelectorAll('.slide');
      imgs.forEach((im,i)=> im.style.opacity = i===0 ? '1' : '0');
      const ms = Math.max(500, parseInt(intervalInput.value) || 2500);
      slideInterval = setInterval(()=>{
        const prev = currentSlide;
        currentSlide = (currentSlide + 1) % slides.length;
        imgs[prev].style.opacity = '0';
        imgs[currentSlide].style.opacity = '1';
      }, ms);
    }
    function pauseSlideshow(){ if (slideInterval){ clearInterval(slideInterval); slideInterval = null; slidesPlaying = false } }
    function resumeSlideshow(){ if (!slidesPlaying) startSlideshow() }
    function stopSlideshow(){ pauseSlideshow(); slideshow.classList.remove('show'); }

    // handle uploaded images
    picsInput.addEventListener('change', e=>{
      const files = Array.from(e.target.files || []);
      files.forEach(f=>{
        const url = URL.createObjectURL(f);
        slides.push(url);
        const tn = document.createElement('img'); tn.src = url; tn.style.width = '64px'; tn.style.height = '64px'; tn.style.objectFit='cover'; tn.style.borderRadius='6px';
        thumbs.appendChild(tn);
      });
      buildSlides();
    });

    clearSlides.addEventListener('click', ()=>{
      slides.forEach(s=>URL.revokeObjectURL(s)); slides = []; thumbs.innerHTML = ''; buildSlides(); stopSlideshow();
    });
    pauseSlides.addEventListener('click', pauseSlideshow);
    resumeSlides.addEventListener('click', resumeSlideshow);

    // start/stop buttons
    startBtn.addEventListener('click', async ()=>{
      startBtn.disabled = true; await loadModels(); await startCamera(); startBtn.disabled = false;
    });
    stopBtn.addEventListener('click', ()=>{ stopCamera(); stopSlideshow(); });

    // quick test button: simulate smile
    testSmile.addEventListener('click', ()=> triggerSmile());

    // cleanup on page unload
    window.addEventListener('unload', ()=>{ stopCamera(); slides.forEach(s=>URL.revokeObjectURL(s)); });

    // note: models are fetched from a public model host. If the models fail to load, check console for network errors.
  </script></body>
</html>
